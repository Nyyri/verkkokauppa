package app;

import java.util.ArrayList;
import java.util.Scanner;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import data.*;

public class Verkkokauppa {

	public static void main(String[] args) {

		Scanner input = new Scanner(System.in);
		String vastaus;
		String vastaus2;
		int vastausint = 0;
		String nimi;
		double hinta = 0;
		String kuvaus;
		String alennus = "0 %";
		int kappalemaara;
		int tuotenro = 0;
		double yhteissumma;
		int check = 1;
//		int koritestaus;
		String kuittitxt = "src/data/kuitti.txt";
		String kuittihistoriatxt = "src/data/kuittihistoria.txt";

		System.out.println("Tervetuloa Verkkokauppaan!");
		System.out.println("Oletko asiakas vai yllÄ‚Â¤pito? (a/y)");
		do {
			vastaus = input.nextLine();

			if (!vastaus.equalsIgnoreCase("a") && !vastaus.equalsIgnoreCase("y")) {

				System.out.println("Virheellinen syÄ‚Â¶te, yritÄ‚Â¤ uudelleen.");

			}

		} while (!vastaus.equalsIgnoreCase("a") && !vastaus.equalsIgnoreCase("y"));

		// Asiakas valittu
		if (vastaus.equalsIgnoreCase("a")) {

			Asiakas Asiakas = new Asiakas();

			System.out.println("Tervetuloa ostoksille!");
			
		//Asiakkaalle tulostetaan ostettavissa olevat tuotteet
			Asiakas.tulostaTuotelista();

			do {
				//Asiakas voi tuotenumeron perusteella tarkastella tuotetta tarkemmin tai lisätä ostoskoriin
				do {
					System.out.println("Anna tuotteen tuotenumero lisÄ‚Â¤tÄ‚Â¤Ä‚Â¤ksesi tuote ostoskoriin: ");
					System.out.println("Voit lukea tuotteen tarkemmat tiedot valitsemalla (t)");
					vastaus = input.nextLine();
					vastaus2 = vastaus;
					if (vastaus.equalsIgnoreCase("t")) {
						System.out.println("Anna tuotteen tuotenumero:");
						check = 1;
						do {
							check = 1;
							try {

								vastausint = Integer.parseInt(input.nextLine());
							} catch (Exception e) {
								check = 0;
								System.out.println("Virheellinen syote, yritÄ‚Â¤ uudelleen.");
							}
						} while (check == 0);
						
						//Asiakkaalle tulostetaan tuotteen tarkempi kuvaus
						Asiakas.naytaTuotteenKuvaus(vastausint);

					}
				} while (vastaus2.equalsIgnoreCase("t"));

				do {
					check = 1;

					try {
						vastausint = Integer.parseInt(vastaus);
					} catch (Exception e) {
						System.out.println("Virheellinen syÄ‚Â¶te, yritÄ‚Â¤ uudelleen.");
						check = 0;
					}
				} while (check == 0);

//					koritestaus = vastausint;
				
				//Tuotteen tiedot String-muodossa > erotellaan oikeiksi muuttujiksi
				String teksti = Asiakas.naytaTuotteenTiedot(vastausint);
				int tuoteID = Integer.parseInt(Asiakas.palautaTuotenro(teksti));
				String tuote = Asiakas.palautaNimi(teksti);
				double hintaDbl = Double.parseDouble(Asiakas.palautaHinta(teksti));
				
				//Kappalemäärän kysely
				System.out.println("Montako kappaletta haluat?");
				do {
					vastaus = input.nextLine();
					check = 1;

					try {
						vastausint = Integer.parseInt(vastaus);
					} catch (Exception e) {
						System.out.println("Virheellinen syÄ‚Â¶te, yritÄ‚Â¤ uudelleen.");
						check = 0;
					}
				} while (check == 0);
				kappalemaara = vastausint;
				
				//Luodaan ostoskoriolio, johon tuotteet luetaan
				Kori ostos = new Kori(tuoteID, tuote, hintaDbl, kappalemaara);
				Asiakas.ostoskori.add(ostos);
//					Kori ostos2 = new Kori(tuoteID, tuote, hintaDbl, kappalemaara);
//					for (int i = 0; i < Asiakas.ostoskori.size(); i++) {
//						if (Asiakas.ostoskori.get(i).tuotenro == koritestaus){
//						Asiakas.ostoskori2.add(ostos);
//						}
//					}

//					System.out.println("AAAAAA " + vastausint);
//					for(int i = 0; i < Asiakas.ostoskori.size(); i++) {
//                        if(Asiakas.ostoskori.get(i).tuotenro == vastausint) {
//                            System.out.println("Tuote on jo ostoskorissa");
//                        }
//                        else {
//                        	Kori ostos = new Kori(tuoteID, tuote, hintaDbl, kappalemaara);
//        					Asiakas.ostoskori.add(ostos);
//                        }
//                    }

				System.out.println("Voit lisÄ‚Â¤tÄ‚Â¤ uuden tuotteen ostoskoriin valitsemalla (k)");
				System.out.println("Voit siirtyÄ‚Â¤ ostoskoriin valitsemalla (o)");
				System.out.println("Voit lukea tuotteen tarkemmat tiedot valitsemalla (t)");

				do {
					vastaus = input.nextLine();
					
					//Asiakas voi tarkastella ostoskorin sisältöä valitsemalla "o", kori tulostetaan
					if (!vastaus.equalsIgnoreCase("k") && (!vastaus.equalsIgnoreCase("o"))
							&& (!vastaus.equalsIgnoreCase("t"))) {
						System.out.println("Virheellinen syÄ‚Â¶te, yritÄ‚Â¤ uudelleen.");

					}
					if (vastaus.equalsIgnoreCase("o")) {
						do {
							System.out.println("Ostoskorisi sisÄ‚Â¤ltÄ‚Â¤Ä‚Â¤:");
							System.out.println("");
							Asiakas.naytaOstoskori();
							System.out.println("Jos haluat lisÄ‚Â¤tÄ‚Â¤ uuden tuotteen ostoskoriin, valitse (k)");
							System.out.println("Voit poistaa tuotteen ostoskorista valitsemalla (p)");
							System.out.println("Jos haluat hyvÄ‚Â¤ksyÄ‚Â¤ tilauksen, valitse (e)");

							vastaus = input.nextLine();
							if (!vastaus.equalsIgnoreCase("k") && (!vastaus.equalsIgnoreCase("e"))
									&& (!vastaus.equalsIgnoreCase("p"))) {
								System.out.println("Virheellinen syote, yrita uudelleen.");
							}
							
							//Asiakas voi poistaa korista tuotteen kirjoittamalla poistettavan tuotteen nimen
							if (vastaus.equalsIgnoreCase("p")) {
								System.out.println("Kirjoita tuotteen nimi jonka haluat poistaa ostoskorista: ");
								vastaus = input.nextLine();
								Asiakas.poistaTuoteKorista(vastaus);
								System.out.println("Tuote " + vastaus + " poistettu ostoskorista.");
							}
						} while (!vastaus.equalsIgnoreCase("e") && !vastaus.equalsIgnoreCase("k"));

					}
						//Jos asiakas kirjoittaa "t", hän voi tarkastella tiettyä tuotetta tarkemmin
					if (vastaus.equalsIgnoreCase("t")) {
						System.out.println("Anna tuotteen tuotenumero:");

						do {
							check = 1;
							try {

								vastausint = Integer.parseInt(input.nextLine());
							} catch (Exception e) {
								check = 0;
								System.out.println("Virheellinen syote, yrita uudelleen.");
							}
						} while (check == 0);
						Asiakas.naytaTuotteenKuvaus(vastausint);
						System.out.println("Voit lisÄ‚Â¤tÄ‚Â¤ uuden tuotteen ostoskoriin valitsemalla (k)");
						System.out.println("Voit siirtyÄ‚Â¤ ostoskoriin valitsemalla (o)");
						System.out.println("Voit lukea tuotteen tarkemmat tiedot valitsemalla (t)");

					}

				} while (!vastaus.equalsIgnoreCase("k") && (!vastaus.equalsIgnoreCase("e")));

			} while (vastaus.equalsIgnoreCase("k"));

			System.out.println("Lopullinen ostoskorisi: ");

//			for(int i = 0; i < Asiakas.ostoskori.size(); i++) {
//                if (Asiakas.ostoskori.get(i).tuotenro == Asiakas.ostoskori2.get(i).tuotenro) {
//                	int maara = Asiakas.ostoskori.get(i).kappalemaara + Asiakas.ostoskori2.get(i).kappalemaara;
//                	System.out.println("AAAAAAAAAAAAA    " + (maara));
//                }
//            }
			
			//Käydään ostoskori läpi, mikäli samaa tuotetta on lisätty moneen kertaan, duplikaatit poistetaan
			//ja kpl-määrät lasketaan yhteen
			for (int i = 0; i < Asiakas.ostoskori.size(); i++) {
				for (int j = i + 1; j < Asiakas.ostoskori.size(); j++) {
					if (Asiakas.ostoskori.get(i).tuotenro == Asiakas.ostoskori.get(j).tuotenro) {
						int summa = Asiakas.ostoskori.get(i).kappalemaara + Asiakas.ostoskori.get(j).kappalemaara;
						Asiakas.ostoskori.get(i).kappalemaara = summa;
						Asiakas.ostoskori.remove(j);
						j--;
					}
				}
			}
			
			//Tulostetaan lopullinen ostoskori
			Asiakas.naytaOstoskori();

			// laskee ostosten yhteissumman korista
			yhteissumma = Asiakas.laskeSumma();
			System.out.printf("Ostostesi yhteissumma on: %.2f â‚¬\r\n", yhteissumma);

			System.out.println("Onko sinulla alennuskoodia? (k/e)");
			vastaus = input.nextLine();

			// Alennuskoodin kysely
			if (vastaus.equalsIgnoreCase("k"))
				do {

					System.out.println("Anna alennuskoodi:");
					vastaus = input.nextLine();

					if (vastaus.equalsIgnoreCase("jippii")) {

						System.out.println("Koodi oikein! Saat 10% alennuksen ostostesi yhteissummasta!");

						yhteissumma = yhteissumma * 0.9;
						alennus = "-10 %";

						System.out.printf("Ostostesi yhteissumma on nyt: %.2f â‚¬\r\n", yhteissumma);
						break;
					} else if (vastaus.equalsIgnoreCase("hurraa")) {

						System.out.println("Koodi oikein! Saat 15% alennuksen ostostesi yhteissummasta!");

						yhteissumma = yhteissumma * 0.85;
						alennus = "-15 %";

						System.out.printf("Ostostesi yhteissumma on nyt: %.2f â‚¬\r\n", yhteissumma);
						break;

					} else if (vastaus.equalsIgnoreCase("wuhuu")) {

						System.out.println("Koodi oikein! Saat 20% alennuksen ostostesi yhteissummasta!");

						yhteissumma = yhteissumma * 0.80;
						alennus = "-20 %";

						System.out.printf("Ostostesi yhteissumma on nyt: %.2f â‚¬\r\n", yhteissumma);
						break;

					} else {
						alennus = "0 %";
						System.out.println(
								"VÃ¤Ã¤rÃ¤ koodi! YritÃ¤ uudelleen tai jatka syÃ¶ttÃ¤mÃ¤Ã¤n asiakastietosi valitsemalla (e)");
					}

				} while (!vastaus.equalsIgnoreCase("e"));

			// Asiakastietojen kysely
			System.out.println("TÃ¤ytÃ¤ asiakastietosi");

			for (int i = 0; i < Asiakas.getTarvittavatAsiakasTiedotLength(); i++) {
				System.out.println(Asiakas.getTarvittavatAsiakasTiedot(i) + ":");

				try {
					vastaus = input.nextLine();
				} catch (Exception e) {
					System.out.println("VÃ¤Ã¤rÃ¤ syÃ¶te");
					i--;
				}

				Asiakas.setAsiakasTieto(i, vastaus);
			}

			//Asiakastiedot lisätään tietokantaan (tilauksen_tuote)
			int tilausID = Tietokanta.lisaaTilaus(Asiakas.getAsiakasTieto(0), Asiakas.getAsiakasTieto(1),
					Asiakas.getAsiakasTieto(2), Asiakas.getAsiakasTieto(3), Asiakas.getAsiakasTieto(4), yhteissumma);

			for (int i = 0; i < Asiakas.ostoskori.size(); i++) {
				Tietokanta.lisaaTuoteTilaukseen(tilausID, Asiakas.ostoskori.get(i).tuotenro,
						Asiakas.ostoskori.get(i).kappalemaara);
			}

			// kuitin tulostus tekstitiedostoon, kuitin tiedostosta tulostus konsoliin
			// ja sen jÄ‚Â¤lkeen tekstitiedoston tyhjennys
			Asiakas.tulostaKoriTiedostoon(yhteissumma, kuittitxt, alennus);
			Asiakas.tulostaKoriTiedostoon(yhteissumma, kuittihistoriatxt, alennus);

			System.out.println(Asiakas.tulostaKuittiKonsoliin(kuittitxt));
			Asiakas.tyhjennaKuitti(kuittitxt);
			
			System.out.println("Kiitos käynnistä!");

		}

		if (vastaus.equalsIgnoreCase("y")) {

			Yllapito Yllapito = new Yllapito();

			// kirjautuminen: kovakoodattu md5 hash
			// pin koodi on: 1234
			String vastauscrypt;
			System.out.println("Anna pin-koodi: ");

			do {
				vastaus = input.nextLine();
				vastauscrypt = Yllapito.crypt(vastaus);
				if (!vastauscrypt.equals("81dc9bdb52d04dc20036dbd8313ed055")) {
					System.out.println("VÄ‚Â¤Ä‚Â¤rÄ‚Â¤ pin-koodi, yritÄ‚Â¤ uudelleen: ");
				}
			} while (!vastauscrypt.equals("81dc9bdb52d04dc20036dbd8313ed055"));

			System.out.println("MitÄ‚Â¤ haluaisit tehdÄ‚Â¤?");

			do {
				System.out.println("Tulosta varasto: valitse (T)");
				System.out.println("Muuttaa tuotteen hintaa: valitse (M)");
				System.out.println("LisÄ‚Â¤Ä‚Â¤ tuote varastoon: valitse (L)");
				System.out.println("NÃ¤ytÃ¤ tÃ¤mÃ¤n hetkiset tilaukset: valitse (N)");
				System.out.println("Poistu (P)");

				vastaus = input.nextLine();

				// Ylläpito voi tulostaa tuotevaraston
				if (vastaus.equalsIgnoreCase("t")) {
					Yllapito.tulostaVarasto();

					// Ylläpito voi muuttaa tietyn tuotteen hintaa
				} else if (vastaus.equalsIgnoreCase("m")) {

					Yllapito.tulostaVarasto();

					do {
						System.out.println("Anna tuotenro:");
						try {
							tuotenro = Integer.parseInt(input.nextLine());
							System.out.println("Anna uusi hinta esim (2.50)");
							hinta = Double.parseDouble(input.nextLine());
							break;
						} catch (Exception e) {
							System.out.println("Virheellinen syï¿½te, yritï¿½ uudelleen.");
						}
					} while (true);

					Yllapito.muutaHintaa(hinta, tuotenro);

					Yllapito.tulostaVarasto();

					// Ylläpito voi lisätä uuden tuotteen varastoon
				} else if (vastaus.equalsIgnoreCase("l")) {

					do {
						System.out.println("Anna tuotteen nimi:");
						nimi = input.nextLine();
						System.out.println("Kirjoita tuotteen kuvaus:");
						kuvaus = input.nextLine();
						System.out.println("Anna tuotteen hinta (esim. 1.50)");
						hinta = Double.parseDouble(input.nextLine());

						Yllapito.lisaaUusiTuote(nimi, kuvaus, hinta);

						System.out.println("Haluatko lisÄ‚Â¤tÄ‚Â¤ uuden tuotteen varastoon? (k/e)");
						vastaus = input.nextLine();

					} while (vastaus.equals("k"));

					Yllapito.tulostaVarasto();
				} else if (vastaus.equalsIgnoreCase("n")) {

					// Ylläpito voi tarkastella tehtyjä asiakastilauksia
					Yllapito.naytaTilaukset();
				} else {
					if (!vastaus.equalsIgnoreCase("p")) {
						System.out.println("Virheellinen syï¿½te, yritï¿½ uudelleen.");
					}
				}

			} while (!vastaus.equalsIgnoreCase("p"));
			System.out.println("");
			System.out.println("Uloskirjautuminen onnistui. Nähdään seuraavalla kerralla!");

		}

	}

}